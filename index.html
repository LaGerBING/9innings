<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHLager ç¦®åŒ…ç²¾ç®—èˆ‡å»£å‘Šç³»çµ±</title>
    <style>
        :root { --primary: #1a73e8; --accent: #34a853; --profit: #d93025; --ad: #e91e63; --bg: #f4f7f6; }
        body { font-family: -apple-system, "Segoe UI", sans-serif; max-width: 1300px; margin: 20px auto; padding: 20px; background: var(--bg); color: #333; line-height: 1.5; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* åŒ¯ç‡èˆ‡åƒæ•¸å€ */
        .config-section { background: #e8f0fe; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #d2e3fc; }
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .setup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.85em; color: #555; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 160px; font-family: monospace; border: 2px solid var(--primary); background: #fafafa; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { border: none; padding: 16px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.3s; color: white; }
        .btn-main { background: var(--primary); }
        .btn-copy-quote { background: var(--accent); }
        .btn-copy-ad { background: var(--ad); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* çµæœé è¦½ */
        h3 { border-left: 5px solid var(--primary); padding-left: 12px; margin-top: 40px; color: #2c3e50; }
        .preview-box { background: #fffdf0; padding: 20px; border: 1px dashed #fbc02d; border-radius: 8px; white-space: pre-wrap; margin-bottom: 20px; font-size: 1.05em; color: #444; }
        
        /* åˆ†æè¡¨æ ¼ */
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.82em; min-width: 1100px; }
        th, td { border: 1px solid #eee; padding: 10px 8px; text-align: center; }
        th { background: #f8f9fa; color: #666; font-weight: 600; }
        
        .hl-blue { color: var(--primary); font-weight: bold; }
        .hl-red { color: var(--profit); font-weight: bold; }
        .hl-green { color: var(--accent); font-weight: bold; }
        .col-profit { background: #fff5f5; }
        
        .calib-info { background: #fffde7; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; border: 1px solid #fbc02d; color: #856404; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ’ CHLager ç¦®åŒ…å ±åƒ¹èˆ‡åˆ©æ½¤ç²¾ç®—ç³»çµ±</h2>
    
    <div class="config-section">
        <div style="margin-bottom: 10px; font-weight: bold; color: var(--primary);">
            <input type="checkbox" id="is_manual" onchange="toggleManual()"> å•Ÿç”¨æ‰‹å‹•åŒ¯ç‡è¦†è“‹
        </div>
        <div class="grid-row">
            <div>
                <label>ç¾å…ƒåŒ¯ç‡ (USD/TWD)</label>
                <input type="number" id="rate_usd" step="0.01" disabled>
            </div>
            <div>
                <label>éŸ“å…ƒåŒ¯ç‡ (KRW/TWD)</label>
                <input type="number" id="rate_krw" step="0.0001" disabled>
            </div>
            <div id="api-status" style="font-size: 0.8em; color: #666;">ğŸ•’ åŒ¯ç‡è®€å–ä¸­...</div>
        </div>
    </div>

    <div class="setup-grid">
        <div>
            <label>é»æ•¸å›é¥‹ç‡ (æ¯1000â‚©)</label>
            <input type="number" id="points_rate" value="1.3" step="0.1">
        </div>
        <div>
            <label>æ”¯ä»˜åƒæ•¸ (é™¤ä»¥ X)</label>
            <input type="number" id="pay_ratio" value="0.985" step="0.001">
        </div>
        <div>
            <label>å®šåƒ¹åƒæ•¸ (ä¹˜ä»¥ X)</label>
            <input type="number" id="price_ratio" value="1.045" step="0.001">
        </div>
        <div>
            <label>å•†åº—æº¢åƒ¹ä¿®æ­£</label>
            <input type="number" id="markup" value="1" step="0.01">
        </div>
        <div>
            <label>é¡¯ç¤ºç²¾åº¦</label>
            <select id="decimal">
                <option value="0">æ•´æ•¸</option>
                <option value="2" selected>ä¿ç•™å…©ä½</option>
            </select>
        </div>
    </div>

    <div style="margin-top: 25px;">
        <label>æ‰¹é‡è¼¸å…¥ (æ ¼å¼ï¼šå°å¹£åŸåƒ¹ æ¨™åƒ¹USD)</label>
        <textarea id="bulk_input">270 6.00
790 18.00
1390 31.50
2690 60.00
3290 75.00</textarea>
    </div>
    
    <div class="btn-group">
        <button class="btn btn-main" onclick="calculateAll()">1. åŸ·è¡Œå®Œæ•´ç²¾ç®—</button>
        <button class="btn btn-copy-quote" onclick="copyText('quote-output')">2. è¤‡è£½è©¢å•å ±åƒ¹</button>
        <button class="btn btn-copy-ad" onclick="copyText('ad-output')">3. è¤‡è£½å»£å‘Šæ–‡æ¡ˆ</button>
    </div>

    <div id="results" style="display:none;">
        <div id="calib-box" class="calib-info"></div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3>âœ‰ï¸ è©¢å•å ±åƒ¹é è¦½</h3>
                <div id="quote-output" class="preview-box"></div>
            </div>
            <div>
                <h3>ğŸ“¢ å»£å‘Šæ–‡æ¡ˆé è¦½</h3>
                <div id="ad-output" class="preview-box" style="background:#fff5f8; border-color:#f06292;"></div>
            </div>
        </div>

        <h3>ğŸ” å…§éƒ¨å…¨æŒ‡æ¨™åˆ©æ½¤åˆ†æ (1~10 é …)</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>1.æ¨™åƒ¹(NT)</th>
                        <th>2.åŸå§‹æŠ˜æ‰£</th>
                        <th>3.æ”¯ä»˜(NT)</th>
                        <th>4.æ”¯ä»˜(KRW)</th>
                        <th>5.æ”¯ä»˜æŠ˜æ‰£</th>
                        <th>6.é è¨ˆå®šåƒ¹</th>
                        <th>7.é»æ•¸</th>
                        <th>8.å›é¥‹é‡‘(æ ¡æº–)</th>
                        <th class="col-profit">9.æ·¨åˆ©(NT)</th>
                        <th class="col-profit">10.ç¸½åˆ©æ½¤%</th>
                    </tr>
                </thead>
                <tbody id="detail-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let apiRates = { usd: 0, krw: 0 };

    // æŠ“å–å³æ™‚åŒ¯ç‡
    async function fetchRates() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            apiRates.usd = data.rates.TWD;
            apiRates.krw = data.rates.TWD / data.rates.KRW;
            updateRateDisplay();
            document.getElementById('api-status').innerText = "âœ… åŒ¯ç‡æ›´æ–°æˆåŠŸ";
        } catch (e) {
            document.getElementById('api-status').innerText = "âŒ åŒ¯ç‡åŒæ­¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥";
        }
    }

    function updateRateDisplay() {
        if(!document.getElementById('is_manual').checked) {
            document.getElementById('rate_usd').value = apiRates.usd.toFixed(2);
            document.getElementById('rate_krw').value = apiRates.krw.toFixed(5);
        }
    }

    function toggleManual() {
        const manual = document.getElementById('is_manual').checked;
        document.getElementById('rate_usd').disabled = !manual;
        document.getElementById('rate_krw').disabled = !manual;
        if(!manual) updateRateDisplay();
    }

    function calculateAll() {
        const uRate = parseFloat(document.getElementById('rate_usd').value);
        const kRate = parseFloat(document.getElementById('rate_krw').value);
        const pRate = parseFloat(document.getElementById('points_rate').value);
        const mUp = parseFloat(document.getElementById('markup').value);
        const payRatio = parseFloat(document.getElementById('pay_ratio').value) || 0.985;
        const priceRatio = parseFloat(document.getElementById('price_ratio').value) || 1.045;
        const dec = parseInt(document.getElementById('decimal').value);
        
        const input = document.getElementById('bulk_input').value.trim();
        if (!input) return;

        const lines = input.split('\n');
        let calibUsd = 31.50; // é è¨­æ ¡æº–åŸºæº–ç¾é‡‘
        
        // è‡ªå‹•å°‹æ‰¾ 1390 å°æ‡‰çš„ç¾é‡‘å€¼é€²è¡Œæ ¡æº–
        lines.forEach(l => {
            let p = l.split(/[\s,]+/).map(v => parseFloat(v));
            if(p[0] === 1390) calibUsd = p[1];
        });

        // --- æ ¸å¿ƒæ ¡æº–é‚è¼¯ ---
        // åŸºæº– A: 35000 éŸ“å…ƒæˆæœ¬
        const cost_A_KRW = (35000 * kRate) / payRatio;
        // åŸºæº– B: 1390ç´šåˆ¥ç¾é‡‘æˆæœ¬
        const cost_B_USD = (calibUsd * uRate) / payRatio;
        // é»æ•¸åƒ¹å€¼ = åƒ¹å·® / 800
        const pointValue = (cost_B_USD - cost_A_KRW) / 800;

        document.getElementById('calib-box').innerHTML = 
            `ğŸ“Š <b>æ ¡æº–è³‡è¨Šï¼š</b> 1390ç´šåˆ¥(${calibUsd} USD)æˆæœ¬: ${cost_B_USD.toFixed(1)} | 35000â‚©æˆæœ¬: ${cost_A_KRW.toFixed(1)}<br>` +
            `æ¯ 1 é»å›é¥‹å°å¹£åƒ¹å€¼ = <b>${pointValue.toFixed(4)}</b> å…ƒ`;

        let priceListText = "";
        let tableBodyHtml = "";

        lines.forEach((line, i) => {
            let parts = line.split(/[\s,]+/).filter(x => x).map(p => parseFloat(p));
            if (parts.length === 0) return;

            let ntdOriginal = parts.length >= 2 ? parts[0] : null;
            let usdTag = parts.length >= 2 ? parts[1] : parts[0];

            // 1~10é …é‹ç®—
            const tagNtd = usdTag * uRate * mUp;
            const disc1 = ntdOriginal ? (tagNtd / ntdOriginal).toFixed(3) : "--";
            const payNtd = tagNtd / payRatio;
            const payKor = payNtd / kRate;
            const disc2 = ntdOriginal ? (payNtd / ntdOriginal).toFixed(3) : "--";
            const retailNtd = payNtd * priceRatio;
            
            const points = (payKor / 1000) * pRate;
            const cashback = points * pointValue; // ä½¿ç”¨æ ¡æº–å¾Œçš„é»æ•¸å–®åƒ¹
            
            const netProfit = retailNtd - payNtd + cashback;
            const profitMargin = (netProfit / payNtd) * 100;

            priceListText += `${ntdOriginal || '--'}>${Math.round(retailNtd)}\n`;

            tableBodyHtml += `<tr>
                <td>${i+1}</td>
                <td>${tagNtd.toFixed(dec)}</td>
                <td>${disc1}</td>
                <td class="hl-blue">${payNtd.toFixed(dec)}</td>
                <td>${Math.round(payKor).toLocaleString()} â‚©</td>
                <td>${disc2}</td>
                <td class="hl-red">${retailNtd.toFixed(dec)}</td>
                <td>${points.toFixed(1)}</td>
                <td>${cashback.toFixed(dec)}</td>
                <td class="hl-green col-profit">${netProfit.toFixed(dec)}</td>
                <td class="hl-green col-profit">${profitMargin.toFixed(2)}%</td>
            </tr>`;
        });

        // ç”Ÿæˆæ–‡æ¡ˆ
        document.getElementById('quote-output').innerText = `æ‚¨å¥½ï¼Œè¬è¬æ‚¨çš„è©¢å•ï¼\nç›®å‰æä¾›ï¼š\n${priceListText}\nè‹¥æ‚¨æœ‰èˆˆè¶£ä¸‹å–®å†éº»ç…©å‘ŠçŸ¥éœ€æ±‚æ•¸é‡ï¼Œ\nä»˜æ¬¾æ–¹å¼å¯ä»¥è½‰å¸³ï¼Œè¬è¬æ‚¨ã€‚`;
        
        document.getElementById('ad-output').innerText = `æ‚¨å¥½ï¼Œè‹¥æ‚¨æœ€è¿‘é‚„éœ€è¦ä»£å„²æœå‹™ï¼Œ\nå¯ä»¥æ‰¾æˆ‘~\n\nç›®å‰æä¾›ï¼š\n${priceListText}\nå®˜æ–¹Line: @969fpbfe\nhttps://line.me/R/ti/p/@969fpbfe\næ­¡è¿è¯çµ¡äº¤æµï¼è¬è¬æ‚¨çš„åƒé–±ğŸ§§`;

        document.getElementById('detail-body').innerHTML = tableBodyHtml;
        document.getElementById('results').style.display = 'block';
    }

    function copyText(elementId) {
        const text = document.getElementById(elementId).innerText;
        if(!text) return alert("è«‹å…ˆåŸ·è¡Œè¨ˆç®—");
        navigator.clipboard.writeText(text).then(() => alert("âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"));
    }

    fetchRates();
</script>

</body>
</html>
